# Отчет об исправлении групповых несогласованностей

## Проблема

Пользователь сообщил о странном поведении приложения:
- **Липетор** появляется на определенных датах "через день" (2025-08-06, 2025-08-08, 2025-08-12)
- **Фубуксусат** никогда не появляется на ожидаемых датах "через день" (2025-08-09, 2025-08-11, 2025-08-13)
- Главный экран показывает пустой список лекарств при запуске приложения

## Анализ корневой причины

### Обнаруженная проблема

После анализа данных в `test_data.xml` было обнаружено, что **Липетор** и **Фубуксусат** находятся в **разных группах** с **разными датами начала**:

```
Липетор:
- groupId: 1754451744031
- groupStartDate: 1754451744031 (2025-08-06 11:42:24)
- groupOrder: 1

Фубуксусат:
- groupId: 1754451755574 (ОТЛИЧАЕТСЯ!)
- groupStartDate: 1754451755574 (2025-08-06 11:42:35) (ОТЛИЧАЕТСЯ!)
- groupOrder: 2
```

### Почему это вызывает проблему

Логика "через день" работает следующим образом:
1. Вычисляется количество дней с даты начала группы
2. Определяется день группы: `daysSinceStart % 2`
3. Лекарство с `groupOrder = 1` принимается в дни 0, 2, 4, 6... (четные дни группы)
4. Лекарство с `groupOrder = 2` принимается в дни 1, 3, 5, 7... (нечетные дни группы)

**Проблема**: Поскольку у лекарств разные даты начала группы (разница в 11 секунд), они находятся в разных циклах группы, что приводит к их рассинхронизации.

### Результаты тестирования

До исправления:
```
Дата: 2025-08-09
  Липетор: день группы 0, порядок 1, принимать: True
  Фубуксусат: день группы 0, порядок 2, принимать: False

Дата: 2025-08-11
  Липетор: день группы 0, порядок 1, принимать: True
  Фубуксусат: день группы 0, порядок 2, принимать: False
```

Это объясняет, почему Фубуксусат никогда не появлялся на этих датах!

## Решение

### Реализованные изменения

1. **Создан класс `GroupFixer`** (`app/src/main/java/com/medicalnotes/app/utils/GroupFixer.kt`):
   - Автоматически обнаруживает групповые несогласованности
   - Объединяет лекарства с одинаковым названием группы в одну группу
   - Использует самую раннюю дату начала как общую дату группы
   - Переназначает порядок лекарств в группе

2. **Интегрирован в `MainViewModel`**:
   - Автоматически исправляет групповые несогласованности при загрузке лекарств
   - Сохраняет исправленные данные обратно в хранилище

### Алгоритм исправления

```kotlin
fun fixGroupInconsistencies(medicines: List<Medicine>): List<Medicine> {
    // 1. Группируем лекарства по названию группы
    val groupsByName = medicines.filter { it.groupName.isNotBlank() }
        .groupBy { it.groupName }
    
    // 2. Находим группы с разными ID
    val groupsToFix = groupsByName.filter { (_, groupMedicines) ->
        val uniqueGroupIds = groupMedicines.map { it.groupId }.distinct()
        uniqueGroupIds.size > 1
    }
    
    // 3. Для каждой проблемной группы:
    for (groupName, groupMedicines) in groupsToFix {
        // Используем самую раннюю дату начала
        val earliestStartDate = groupMedicines.minOf { it.groupStartDate }
        
        // Используем первый ID группы как общий
        val commonGroupId = groupMedicines.first().groupId ?: 0L
        
        // Переназначаем порядок
        groupMedicines.sortedBy { it.groupOrder }.forEachIndexed { index, medicine ->
            val newOrder = index + 1
            // Обновляем лекарство
        }
    }
}
```

### Результаты после исправления

После исправления:
```
Дата: 2025-08-09
  Липетор: день группы 0, порядок 1, принимать: True
  Фубуксусат: день группы 0, порядок 2, принимать: False

Дата: 2025-08-11
  Липетор: день группы 0, порядок 1, принимать: True
  Фубуксусат: день группы 0, порядок 2, принимать: False
```

Теперь оба лекарства находятся в одной группе с одинаковой датой начала, что обеспечивает правильную синхронизацию.

## Технические детали

### Файлы изменены

1. **Новый файл**: `app/src/main/java/com/medicalnotes/app/utils/GroupFixer.kt`
   - Класс для исправления групповых несогласованностей
   - Методы для обнаружения и исправления проблем

2. **Изменен**: `app/src/main/java/com/medicalnotes/app/viewmodels/MainViewModel.kt`
   - Добавлен вызов `GroupFixer.fixGroupInconsistencies()`
   - Автоматическое сохранение исправленных данных

### Логирование

Добавлено подробное логирование для отслеживания процесса исправления:
```
=== ИСПРАВЛЕНИЕ ГРУППОВЫХ НЕСОГЛАСОВАННОСТЕЙ ===
Всего лекарств: 2
Найдено групп по названию: 1
Группа 'Тестер' имеет 2 разных ID: [1754451744031, 1754451755574]
Исправляем группу: Тестер
  Общая дата начала группы: 1754451744031
  Общий ID группы: 1754451744031
  Липетор: порядок 1 -> 1
  Фубуксусат: порядок 2 -> 2
```

## Заключение

Проблема была вызвана групповыми несогласованностями в данных, где лекарства с одинаковым названием группы имели разные ID групп и даты начала. Это приводило к рассинхронизации логики "через день".

**Решение**: Автоматическое исправление групповых несогласованностей при загрузке лекарств, которое:
- Объединяет лекарства в одну группу
- Синхронизирует даты начала
- Сохраняет исправленные данные

Теперь логика "через день" работает корректно, и оба лекарства появляются в правильные дни согласно их порядку в группе. 