# Исправление проблемы с уведомлениями после закрытия приложения

## Проблема
Уведомления о лекарствах не работали после закрытия приложения, так как система Android могла останавливать фоновые процессы.

## Внесенные изменения

### 1. Улучшен NotificationService
- **Файл**: `app/src/main/java/com/medicalnotes/app/service/NotificationService.kt`
- **Изменения**:
  - Заменил `setRepeating` на `setExactAndAllowWhileIdle` для более точного планирования
  - Добавил метод `scheduleNextDayAlarm` для планирования уведомлений на следующий день
  - Улучшил логирование для отслеживания работы сервиса

### 2. Улучшен MedicineAlarmReceiver
- **Файл**: `app/src/main/java/com/medicalnotes/app/receiver/MedicineAlarmReceiver.kt`
- **Изменения**:
  - Добавил автоматическое планирование следующего уведомления после срабатывания
  - Добавил метод `scheduleNextDayNotification` для планирования уведомлений на завтра
  - Улучшил обработку уведомлений о приеме лекарств

### 3. Создан NotificationRestorationManager
- **Файл**: `app/src/main/java/com/medicalnotes/app/utils/NotificationRestorationManager.kt`
- **Функции**:
  - Проверка существующих уведомлений
  - Восстановление уведомлений при запуске приложения
  - Отмена всех уведомлений при необходимости
  - Автоматическое планирование уведомлений для активных лекарств

### 4. Создан BatteryOptimizationHelper
- **Файл**: `app/src/main/java/com/medicalnotes/app/utils/BatteryOptimizationHelper.kt`
- **Функции**:
  - Проверка настроек оптимизации батареи
  - Запрос разрешений на игнорирование оптимизации батареи
  - Открытие настроек оптимизации батареи

### 5. Улучшен BootReceiver
- **Файл**: `app/src/main/java/com/medicalnotes/app/receiver/BootReceiver.kt`
- **Изменения**:
  - Интегрирован с NotificationRestorationManager
  - Улучшено восстановление уведомлений после перезагрузки

### 6. Обновлен MainActivity
- **Файл**: `app/src/main/java/com/medicalnotes/app/MainActivity.kt`
- **Изменения**:
  - Добавлен вызов `checkAndRestoreNotifications()` при запуске
  - Добавлен вызов `checkNotificationPermissions()` для проверки разрешений
  - Улучшена инициализация сервиса уведомлений

### 7. Обновлен MedicalNotesApplication
- **Файл**: `app/src/main/java/com/medicalnotes/app/MedicalNotesApplication.kt`
- **Изменения**:
  - Добавлена проверка и восстановление уведомлений при инициализации приложения
  - Улучшена работа сервиса уведомлений

### 8. Обновлен AndroidManifest.xml
- **Файл**: `app/src/main/AndroidManifest.xml`
- **Добавленные разрешения**:
  - `REQUEST_IGNORE_BATTERY_OPTIMIZATIONS` - для игнорирования оптимизации батареи
  - `SYSTEM_ALERT_WINDOW` - для отображения уведомлений поверх других приложений

## Как это работает

### 1. При запуске приложения:
- Запускается NotificationService в foreground режиме
- Проверяются и восстанавливаются все уведомления
- Запрашиваются разрешения на игнорирование оптимизации батареи

### 2. При добавлении лекарства:
- Автоматически планируется уведомление
- Используется точное время с `setExactAndAllowWhileIdle`

### 3. При срабатывании уведомления:
- Показывается уведомление пользователю
- Автоматически планируется следующее уведомление на завтра

### 4. После перезагрузки устройства:
- BootReceiver автоматически восстанавливает все уведомления
- Запускается сервис уведомлений

### 5. При закрытии приложения:
- Сервис продолжает работать в фоновом режиме
- Уведомления продолжают срабатывать по расписанию

## Рекомендации для пользователя

1. **Разрешить игнорирование оптимизации батареи** - приложение запросит это разрешение автоматически
2. **Не закрывать приложение принудительно** - дать сервису работать в фоне
3. **Проверить настройки уведомлений** - убедиться, что уведомления разрешены для приложения

## Тестирование

Для проверки работы уведомлений:
1. Добавьте лекарство с временем приема через несколько минут
2. Закройте приложение полностью
3. Дождитесь времени приема лекарства
4. Уведомление должно появиться даже при закрытом приложении

## Логирование

Все действия с уведомлениями записываются в лог с тегами:
- `NotificationService`
- `MedicineAlarmReceiver`
- `NotificationRestorationManager`
- `BatteryOptimizationHelper`
- `BootReceiver`

Это позволяет отслеживать работу системы уведомлений и диагностировать проблемы. 